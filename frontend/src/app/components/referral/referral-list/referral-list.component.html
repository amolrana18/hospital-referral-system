<div class="referral-list-container">
  <!-- Header -->
  <div class="header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2>Referral Management</h2>
        <p class="text-muted mb-0">Manage patient referrals between hospitals</p>
      </div>
      <button class="btn btn-primary" (click)="navigateToNewReferral()">
        <i class="fas fa-plus me-2"></i>New Referral
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading referrals...</p>
  </div>

  <!-- Filters -->
  <div *ngIf="!loading" class="card filters-card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="filters.status" (change)="applyFilters()">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Priority</label>
          <select class="form-select" [(ngModel)]="filters.priority" (change)="applyFilters()">
            <option *ngFor="let priority of priorityOptions" [value]="priority.value">
              {{ priority.label }}
            </option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" 
                   class="form-control" 
                   placeholder="Search patient, hospital, or referral code..."
                   [(ngModel)]="filters.search"
                   (keyup)="applyFilters()">
          </div>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="fas fa-times me-1"></i>Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Referral Table -->
  <div *ngIf="!loading" class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">All Referrals</h5>
      <span class="badge bg-primary">{{ dataSource.filteredData.length }} referrals</span>
    </div>
    
    <div class="card-body">
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z0">
          
          <!-- Referral Code Column -->
          <ng-container matColumnDef="referral_code">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Referral Code</th>
            <td mat-cell *matCellDef="let referral">
              <div class="referral-code">
                <strong>{{ referral.referral_code }}</strong>
                <small class="d-block text-muted">
                  <i class="fas fa-arrow-right me-1" [ngClass]="getReferralDirectionClass(referral)"></i>
                  {{ getReferralDirection(referral) }}
                </small>
              </div>
            </td>
          </ng-container>

          <!-- Patient Column -->
          <ng-container matColumnDef="patient">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient</th>
            <td mat-cell *matCellDef="let referral">
              <div class="patient-info">
                <h6 class="mb-1">{{ referral.patient_first_name }} {{ referral.patient_last_name }}</h6>
                <small class="text-muted">
                  <i class="fas fa-phone me-1"></i>{{ referral.patient_phone }}
                </small>
              </div>
            </td>
          </ng-container>

          <!-- Hospitals Column -->
          <ng-container matColumnDef="hospitals">
            <th mat-header-cell *matHeaderCellDef>From â†’ To</th>
            <td mat-cell *matCellDef="let referral">
              <div class="hospital-info">
                <small class="text-muted d-block">From</small>
                <small class="d-block">{{ referral.referring_hospital_name }}</small>
                <small class="text-muted d-block mt-1">To</small>
                <small class="d-block">{{ referral.receiving_hospital_name }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Priority</th>
            <td mat-cell *matCellDef="let referral">
              <span class="badge" [ngClass]="getPriorityBadgeClass(referral.priority)">
                {{ referral.priority }}
              </span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let referral">
              <span class="badge" [ngClass]="getStatusBadgeClass(referral.status)">
                {{ referral.status }}
              </span>
            </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
            <td mat-cell *matCellDef="let referral">
              {{ referral.referral_date | date:'medium' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
            <td mat-cell *matCellDef="let referral" class="text-end">
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" 
                        (click)="navigateToReferralDetail(referral.referral_id)">
                  <i class="fas fa-eye"></i>
                </button>
                
                <!-- Action buttons for hospital admin -->
                <div *ngIf="canTakeAction(referral)" class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-success" 
                          (click)="approveReferral(referral)">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="rejectReferral(referral)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <!-- No Data Row -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell text-center py-4" colspan="7">
              <i class="fas fa-ambulance fa-2x text-muted mb-3"></i>
              <p class="text-muted mb-0">No referrals found</p>
            </td>
          </tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </div>
  </div>
</div>